{{ define "main" }}
{{ $currentTag := .Title }}
{{ $currentSection := "software-engineering" }}
{{ $sectionName := "Software Engineering" }}

<!-- Determine section from URL path -->
{{ $pathParts := split .RelPermalink "/" }}
{{ if ge (len $pathParts) 3 }}
    <!-- Path like /section/tags/ -->
    {{ if eq (index $pathParts 2) "tags" }}
        {{ $currentSection = index $pathParts 1 }}
        {{ $sectionName = $currentSection | title | replaceRE "-" " " }}
    {{ end }}
{{ end }}

<div class="container section-container">
    <div class="content-list">
        <h1>{{ $currentTag | title }}</h1>
        {{ if .Content }}
        <div class="section-content">
            {{ .Content }}
        </div>
        {{ end }}
        
        <!-- Find articles with this specific tag -->
        {{ $articlesWithTag := slice }}
        
        {{ range .Site.RegularPages }}
            {{ $pageSection := .Section }}
            {{ $page := . }}
            
            <!-- Check tags based on current section -->
            {{ if eq $currentSection "software-engineering" }}
                {{ if and (eq $pageSection "software-engineering") .Params.se_tags }}
                    {{ range .Params.se_tags }}
                        {{ if eq (. | urlize) ($currentTag | urlize) }}
                            {{ $articlesWithTag = $articlesWithTag | append $page }}
                        {{ end }}
                    {{ end }}
                {{ end }}
            {{ else if eq $currentSection "building-wealth" }}
                {{ if and (eq $pageSection "building-wealth") .Params.bw_tags }}
                    {{ range .Params.bw_tags }}
                        {{ if eq (. | urlize) ($currentTag | urlize) }}
                            {{ $articlesWithTag = $articlesWithTag | append $page }}
                        {{ end }}
                    {{ end }}
                {{ end }}
            {{ end }}
        {{ end }}
        
        {{ if $articlesWithTag }}
        <div class="posts-grid">
            {{ range $articlesWithTag }}
            <article class="content-card">
                <a href="{{ .RelPermalink }}" class="card-link">
                    <!-- Image if specified -->
                    {{ if .Params.image }}
                    <div class="card-image">
                        <img src="{{ .Params.image | absURL }}" alt="{{ .Title }}" loading="lazy">
                    </div>
                    {{ else if .Params.youtube_id }}
                    <div class="card-image video-image">
                        <img src="https://img.youtube.com/vi/{{ .Params.youtube_id }}/maxresdefault.jpg"
                            alt="{{ .Title }}" loading="lazy">
                        <div class="video-overlay">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="white">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        </div>
                        {{ if .Params.duration }}
                        <span class="duration-badge">{{ .Params.duration }}</span>
                        {{ end }}
                    </div>
                    {{ end }}
                    
                    <div class="card-content">
                        <!-- Icon and Title -->
                        <div class="card-header">
                            {{ $contentIcon := "üìÑ" }}
                            {{ if in .RelPermalink "/videos/" }}{{ $contentIcon = "üé•" }}
                            {{ else if in .RelPermalink "/blogs/" }}{{ $contentIcon = "üìù" }}
                            {{ else if in .RelPermalink "/tools/" }}{{ $contentIcon = "üõ†Ô∏è" }}
                            {{ else if in .RelPermalink "/slides/" }}{{ $contentIcon = "üéØ" }}
                            {{ else if in .RelPermalink "/books/" }}{{ $contentIcon = "üìö" }}
                            {{ end }}
                            <span class="content-icon">{{ $contentIcon }}</span>
                            <h2 class="card-title">{{ .Title }}</h2>
                        </div>
                        
                        <!-- Summary -->
                        {{ if or .Summary .Description .Params.summary }}
                        <p class="card-summary">{{ or .Summary .Description .Params.summary }}</p>
                        {{ end }}
                        
                        <!-- Meta information -->
                        <div class="card-meta">
                            {{ if .Date }}
                            <span class="meta-item">
                                <span class="meta-icon">üìÖ</span>
                                <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "Jan 2, 2006" }}</time>
                            </span>
                            {{ end }}
                            
                            <!-- Content-specific meta with simplified logic -->
                            {{ if .Content }}
                            {{ $words := len (split (plainify .Content) " ") }}
                            {{ $readTime := math.Ceil (div $words 200.0) }}
                            {{ if gt $readTime 0 }}
                            <span class="meta-item">
                                <span class="meta-icon">‚è±Ô∏è</span>
                                <span class="read-time">{{ $readTime }} min read</span>
                            </span>
                            {{ end }}
                            {{ end }}
                        </div>
                        
                        <!-- Tags -->
                        {{ $currentTaxonomy := "" }}
                        {{ if eq $currentSection "software-engineering" }}
                            {{ $currentTaxonomy = "se_tags" }}
                        {{ else if eq $currentSection "building-wealth" }}
                            {{ $currentTaxonomy = "bw_tags" }}
                        {{ end }}
                        
                        {{ if $currentTaxonomy }}
                            {{ $tags := index .Params $currentTaxonomy }}
                            {{ if $tags }}
                            <div class="card-tags">
                                {{ range $tags }}
                                {{ $tagUrl := printf "/%s/tags/%s/" $currentSection (. | urlize) }}
                                <a href="{{ $tagUrl | absURL }}" class="tag-link">{{ . | title }}</a>
                                {{ end }}
                            </div>
                            {{ end }}
                        {{ end }}
                    </div>
                </a>
            </article>
            {{ end }}
        </div>
        
        <div class="articles-stats">
            <p>{{ len $articlesWithTag }} {{ if eq (len $articlesWithTag) 1 }}article{{ else }}articles{{ end }} found with tag "{{ $currentTag | title }}" in {{ $sectionName }}.</p>
        </div>
        {{ else }}
        <p class="no-content">No articles found with tag "{{ $currentTag | title }}" in {{ $sectionName }}.</p>
        {{ end }}
    </div>
</div>
{{ end }}