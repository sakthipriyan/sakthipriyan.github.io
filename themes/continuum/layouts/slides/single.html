{{ define "head" }}
{{ end }}

{{ define "main" }}
<div class="reveal">
    <div class="slides">
        <section data-markdown data-separator="^---$" data-separator-vertical="^--$" data-separator-notes="^Note:" data-charset="utf-8">
            <textarea data-template>{{ .RawContent }}</textarea>
        </section>
    </div>
</div>
{{ end }}

{{ define "scripts" }}
<script>
    // Render DOT diagrams in a slide (or all slides if slide=null)
    function renderGraphviz(slide = null) {
        const slides = slide ? [slide] : Array.from(Reveal.getSlides());
        slides.forEach(slideEl => {
            slideEl.querySelectorAll('pre code.dot, pre.language-dot, pre.dot').forEach(codeEl => {
                if (codeEl.dataset.rendered) return;

                const dotCode = codeEl.textContent.replace(/&gt;/g, '>').replace(/&lt;/g, '<');
                console.log('[DEBUG] Rendering DOT block:\n', dotCode);

                const viz = new Viz();
                viz.renderSVGElement(dotCode)
                    .then(svg => {
                        // Remove width/height attributes from SVG for auto-scaling
                        svg.removeAttribute('width');
                        svg.removeAttribute('height');
                        svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');

                        // Wrap in a flex container
                        const container = document.createElement('div');
                        container.className = 'graphviz';
                        container.appendChild(svg);

                        // Replace the <pre> entirely
                        const preEl = codeEl.parentNode;
                        preEl.parentNode.replaceChild(container, preEl);

                        codeEl.dataset.rendered = true;
                        console.log('[DEBUG] Diagram rendered and pre replaced.');
                    })
                    .catch(err => {
                        console.error('[DEBUG] Viz.js error:', err);
                        codeEl.parentNode.textContent = "Error rendering diagram: " + err;
                    });
            });
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        Reveal.initialize({
            hash: true,
            plugins: [RevealMarkdown, RevealHighlight, RevealNotes],
            transition: 'slide',
            slideNumber: false,
            margin: 0.05,
            width: "100%",
            height: "100%",
            minScale: 1,
            maxScale: 1,
            progress: true
        });

        // Pre-render all slides after Markdown is parsed
        Reveal.addEventListener('ready', event => {
            console.log('[DEBUG] Reveal ready, rendering all slides...');
            // Force parse all slides
            Reveal.getSlides().forEach(slideEl => {
                if (slideEl.dataset.parsed) return;
                if (slideEl.querySelector('textarea[data-template]')) {
                    RevealMarkdown.parseSlide(slideEl);
                    slideEl.dataset.parsed = true;
                }
            });
            renderGraphviz(); // render all slides
        });

        // Render diagrams on slide change (for dynamically added slides)
        Reveal.on('slidechanged', event => {
            console.log('[DEBUG] Slide changed to index', event.indexh);
            renderGraphviz(event.currentSlide);
        });

        // Render diagrams when Markdown plugin parses a slide
        Reveal.addEventListener('markdown', event => {
            console.log('[DEBUG] Markdown parsed for slide', event.slide);
            renderGraphviz(event.slide);
        });
    });
</script>
{{ end }}