<!DOCTYPE html>
<html lang="{{ .Site.LanguageCode | default "en" }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ if .Title }}{{ .Title }} | {{ end }}{{ .Site.Title }}</title>
    <meta name="description" content="{{ .Description | default .Site.Params.description }}">
    <link rel="stylesheet" href="{{ "/css/style.css" | absURL }}">
    <link rel="stylesheet" href="{{ "/css/book-layout.css" | absURL }}">
</head>

<body class="book-reader {{ .Section }}">
    {{- /* Check if this is the books list page or a specific book page */ -}}
    {{- $isBooksListPage := or (eq .RelPermalink "/building-systems/books/") (eq .RelPermalink "/building-wealth/books/") -}}

    {{- if $isBooksListPage -}}
    {{- /* This is the books list page - use default layout */ -}}
    {{ partial "header.html" . }}
    {{ partial "breadcrumb.html" . }}
    <main>
        <section class="books-list">
            <h1>{{ .Title }}</h1>
            {{- if .Content }}
            <div class="section-content">
                {{ .Content }}
            </div>
            {{- end }}

            <div class="posts-grid">
                {{- range .Pages }}
                {{ partial "content-card.html" . }}
                {{- end }}
            </div>
        </section>
    </main>
    {{ partial "footer.html" . }}
    {{- else -}}
    {{- /* This is a specific book - use book reader layout */ -}}
    {{- /* Check if this book is in draft mode */ -}}
    {{- if .Draft -}}
    {{- /* Book is in draft - show message or redirect */ -}}
    {{ partial "header.html" . }}
    {{ partial "breadcrumb.html" . }}
    <main>
        <section class="draft-notice">
            <h1>{{ .Title }}</h1>
            <p>This book is currently in draft mode and not yet published.</p>
        </section>
    </main>
    {{ partial "footer.html" . }}
    {{- else -}}
    {{- /* Book is published - show book reader layout */ -}}
    
    {{ partial "book-header.html" . }}
    {{ partial "book-toc.html" . }}

    {{- /* Main Content */ -}}
    <main class="book-main-content">
        <div class="book-content-wrapper">
            <article class="book-chapter">
                <header class="chapter-header">
                    <h1 class="chapter-title">{{ .Title }}</h1>
                    {{- if .Params.subtitle }}
                    <p class="chapter-subtitle">{{ .Params.subtitle }}</p>
                    {{- end }}
                </header>

                <div class="chapter-body">
                    {{ .Content }}
                </div>

                {{- /* Show chapter list on book index */ -}}
                {{- $chapters := where .Pages ".Params.chapter" "!=" nil -}}
                {{- if $chapters }}
                <nav class="book-chapters-overview">
                    <h2>Chapters</h2>
                    <ol class="chapters-overview-list">
                        {{- range sort $chapters ".Params.chapter" }}
                        <li class="chapter-overview-item">
                            <a href="{{ .RelPermalink }}" class="chapter-overview-link">
                                {{- if .Params.chapter }}<strong>CHAPTER {{ .Params.chapter }}</strong> {{ end -}}
                                <span class="chapter-overview-title">{{ .Title }}</span>
                                {{- with .Params.subtitle }}
                                <span class="chapter-overview-subtitle">{{ . }}</span>
                                {{- end }}
                            </a>
                        </li>
                        {{- end }}
                    </ol>
                </nav>
                {{- end }}
            </article>
        </div>
    </main>

    {{- /* Overlay for mobile TOC */ -}}
    <div class="book-toc-overlay"></div>

    {{- /* Scripts */ -}}
    {{ partial "book-scripts.html" . }}

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-5NGEJ767SK"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-5NGEJ767SK');
    </script>
    {{- end -}}
    {{- end -}}
</body>
</html>